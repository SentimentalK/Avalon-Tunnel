# Avalon Tunnel - Caddy Configuration
# 自动 TLS 证书申请和反向代理配置

# 只为主域名申请证书
{$DOMAIN:your-domain.com} {
    # 根路径 - 伪装网站
    handle / {
        root * /srv
        file_server
        header Cache-Control "no-cache, no-store, must-revalidate"
        header Pragma "no-cache"
        header Expires "0"
    }

    # 秘密路径 - V2Ray WebSocket 代理
    # 请修改为您的自定义路径，建议使用随机字符串
    # 使用 127.0.0.1 因为在 host 网络模式下
    handle /{$SECRET_PATH:avalon-secret-path} {
        reverse_proxy 127.0.0.1:10000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
        }
    }

    # 安全头设置
    header {
        # 隐藏服务器信息
        -Server
        Server "nginx/1.18.0"
        
        # 安全头
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        
        # 防止缓存敏感路径
        Cache-Control "no-cache, no-store, must-revalidate"
    }

    # 日志配置
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

