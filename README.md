# Avalon Tunnel

**æ™ºèƒ½åŒ–çš„ V2Ray ä»£ç†ç®¡ç†ç³»ç»Ÿï¼Œä¸“ä¸º IPv6-only ç¯å¢ƒä¼˜åŒ–**

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **æµé‡ä¼ªè£…**ï¼šä¼ªè£…æˆæ­£å¸¸ HTTPS ç½‘ç«™ï¼Œé€šè¿‡ WebSocket ä¼ è¾“ä»£ç†æµé‡
- **å¤šç”¨æˆ·ç®¡ç†**ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ UUID + ç‹¬ç«‹ç§˜å¯†è·¯å¾„ï¼Œå¼ºç»‘å®šé˜²æ­¢æ»¥ç”¨
- **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šä¸€é”®éƒ¨ç½²ï¼Œè‡ªåŠ¨é…ç½®é˜²ç«å¢™ã€TLS è¯ä¹¦ã€æœåŠ¡éªŒè¯
- **RESTful API**ï¼šåŠ¨æ€ç”¨æˆ·ç®¡ç†ã€é…ç½®çƒ­æ›´æ–°ã€è®¾å¤‡è®¿é—®è¿½è¸ª
- **IPv6 ä¼˜å…ˆ**ï¼šé’ˆå¯¹ IPv6-only ç¯å¢ƒä¼˜åŒ–ï¼Œè‡ªåŠ¨ DNS64/NAT64 é…ç½®

---

## ğŸ—ï¸ æ¶æ„æµç¨‹

```mermaid
graph TB
    Client[å®¢æˆ·ç«¯<br/>VLESS Client]
    Internet[äº’è”ç½‘]
    Firewall[é˜²ç«å¢™<br/>UFW + VPC]
    Caddy[Caddy åå‘ä»£ç†<br/>TLS + æµé‡åˆ†å‘]
    FakeSite[ä¼ªè£…ç½‘ç«™<br/>æŠ€æœ¯åšå®¢]
    API[API æœåŠ¡<br/>ç”¨æˆ·ç®¡ç†]
    V2Ray1[V2Ray Inbound 1<br/>ç”¨æˆ·1: UUID-1 + Path-1]
    V2Ray2[V2Ray Inbound 2<br/>ç”¨æˆ·2: UUID-2 + Path-2]
    DB[(SQLite æ•°æ®åº“<br/>ç”¨æˆ·/è®¾å¤‡/æ—¥å¿—)]
    
    Client -->|HTTPS 443| Internet
    Internet -->|HTTPS| Firewall
    Firewall -->|å…è®¸ 80/443| Caddy
    
    Caddy -->|è·¯å¾„: /| FakeSite
    Caddy -->|è·¯å¾„: /api/*| API
    Caddy -->|è·¯å¾„: /secret-path-1| V2Ray1
    Caddy -->|è·¯å¾„: /secret-path-2| V2Ray2
    
    API <-->|è¯»å†™| DB
    V2Ray1 -.->|è®°å½•è®¿é—®| DB
    V2Ray2 -.->|è®°å½•è®¿é—®| DB
    
    style Caddy fill:#667eea
    style FakeSite fill:#48bb78
    style API fill:#ed8936
    style DB fill:#4299e1
```

**æµé‡ä¼ªè£…åŸç†**ï¼š
1. å¤–éƒ¨çœ‹èµ·æ¥æ˜¯è®¿é—® `https://your-domain.com`ï¼ˆæ­£å¸¸ HTTPS ç½‘ç«™ï¼‰
2. æ ¹è·¯å¾„ `/` æ˜¾ç¤ºæŠ€æœ¯åšå®¢ï¼ˆä¼ªè£…å†…å®¹ï¼‰
3. åªæœ‰çŸ¥é“ç§˜å¯†è·¯å¾„çš„å®¢æˆ·ç«¯æ‰èƒ½è¿æ¥ä»£ç†ï¼ˆå¦‚ `/vaa7JWI4...`ï¼‰
4. UUID å’Œè·¯å¾„å¼ºç»‘å®šï¼Œé˜²æ­¢å‡­è¯åˆ†äº«

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶

- **æœåŠ¡å™¨**ï¼šUbuntu 20.04+ï¼Œæ”¯æŒ IPv6
- **åŸŸå**ï¼šå·²è§£æåˆ°æœåŠ¡å™¨ IP
- **ç«¯å£**ï¼šå¼€æ”¾ 80/443ï¼ˆVPC å®‰å…¨ç»„ + UFWï¼‰

### ä¸€é”®éƒ¨ç½²

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/Avalon-Tunnel.git
cd Avalon-Tunnel

# 2. é…ç½®åŸŸå
echo "DOMAIN=your-domain.com" > .env

# 3. å®Œæ•´éƒ¨ç½²ï¼ˆé˜²ç«å¢™ + é…ç½® + å¯åŠ¨ + éªŒè¯ + APIï¼‰
make deploy
```

**å°±è¿™ä¹ˆç®€å•ï¼** ğŸ‰

éƒ¨ç½²å®Œæˆåï¼š
- âœ… V2Ray ä»£ç†æœåŠ¡è¿è¡Œåœ¨åå°
- âœ… Caddy è‡ªåŠ¨ç”³è¯· TLS è¯ä¹¦
- âœ… é»˜è®¤ç”¨æˆ· `Morgan` å·²åˆ›å»º
- âœ… API æœåŠ¡è¿è¡Œåœ¨ `https://your-domain.com/api`

---

## ğŸ“± å®¢æˆ·ç«¯è¿æ¥

éƒ¨ç½²æˆåŠŸåï¼Œç»ˆç«¯ä¼šæ˜¾ç¤ºè¿æ¥ä¿¡æ¯ï¼š

```
ğŸ“§ ç”¨æˆ·: Morgan@avalon-tunnel.com
ğŸ†” UUID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
ğŸ”— è¿æ¥: vless://a1b2c3d4-...@your-domain.com:443?type=ws&security=tls&path=%2Fsecret-path...
```

**é‡è¦**ï¼šIPv6-only æœåŠ¡å™¨éœ€åœ¨å®¢æˆ·ç«¯å¼€å¯ **"ä¼˜å…ˆä½¿ç”¨ IPv6"**

---

## ğŸ”§ ç®¡ç†å‘½ä»¤

### æ ¸å¿ƒæœåŠ¡
```bash
make start        # å¯åŠ¨æ ¸å¿ƒæœåŠ¡ï¼ˆV2Ray + Caddyï¼‰
make stop         # åœæ­¢æ‰€æœ‰æœåŠ¡
make restart      # é‡å¯æ ¸å¿ƒæœåŠ¡
make status       # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```

### API ç®¡ç†
```bash
make api-start    # å¯åŠ¨ API æœåŠ¡å™¨
make api-stop     # åœæ­¢ API æœåŠ¡å™¨
make api-logs     # æŸ¥çœ‹ API æ—¥å¿—
```

### é…ç½®ä¸è¯Šæ–­
```bash
make config       # é‡æ–°ç”Ÿæˆé…ç½®æ–‡ä»¶
make check-pre    # ç¯å¢ƒé¢„æ£€æŸ¥
make check-post   # æœåŠ¡éªŒè¯
make clean        # æ¸…ç†æ‰€æœ‰å®¹å™¨
make clean-data   # âš ï¸ æ¸…ç†ç”¨æˆ·æ•°æ®ï¼ˆå±é™©ï¼‰
```

---

## ğŸŒ API ä½¿ç”¨

### è®¿é—® API æ–‡æ¡£
```
https://your-domain.com/docs
```

### åˆ›å»ºæ–°ç”¨æˆ·
```bash
curl -X POST https://your-domain.com/api/users \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com"}'
```

### è·å–ç”¨æˆ·åˆ—è¡¨
```bash
curl https://your-domain.com/api/users
```

### æŸ¥çœ‹è®¾å¤‡è®¿é—®è®°å½•
```bash
curl https://your-domain.com/api/devices
```

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### å¤šå±‚é˜²æŠ¤
1. **UUID + è·¯å¾„å¼ºç»‘å®š**ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ inboundï¼ŒUUID å’Œç§˜å¯†è·¯å¾„ä¸€ä¸€å¯¹åº”
2. **æµé‡ä¼ªè£…**ï¼šå¤–éƒ¨çœ‹èµ·æ¥æ˜¯æ­£å¸¸ HTTPS ç½‘ç«™
3. **è®¾å¤‡è¿½è¸ª**ï¼šè®°å½• User-Agentã€IPã€è®¿é—®è·¯å¾„ï¼ˆä¸ºæœªæ¥è®¾å¤‡é™åˆ¶åšå‡†å¤‡ï¼‰
4. **TLS åŠ å¯†**ï¼šæ‰€æœ‰æµé‡é€šè¿‡ Let's Encrypt è¯ä¹¦åŠ å¯†

### é˜²æ»¥ç”¨æœºåˆ¶
- âŒ **æ— æ³•åˆ†äº«å‡­è¯**ï¼šUUID å’Œè·¯å¾„ç»‘å®šï¼Œåˆ†äº«æ— æ•ˆ
- âœ… **è®¾å¤‡è¿½è¸ª**ï¼šè®°å½•æ¯ä¸ªè®¾å¤‡çš„è®¿é—®å†å²
- ğŸ”œ **è®¾å¤‡é™åˆ¶**ï¼šæœªæ¥æ”¯æŒé™åˆ¶è®¾å¤‡æ•°é‡

---

## ğŸ“Š å¼€å‘è·¯çº¿å›¾

### âœ… Phase 1ï¼ˆå·²å®Œæˆï¼‰
- [x] åŸºç¡€ä»£ç†åŠŸèƒ½ï¼ˆV2Ray + Caddyï¼‰
- [x] æµé‡ä¼ªè£…ï¼ˆWebSocket + TLSï¼‰
- [x] è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
- [x] IPv6-only ç¯å¢ƒä¼˜åŒ–
- [x] å¤šç”¨æˆ·å¤šè·¯å¾„æ¶æ„

### âœ… Phase 2ï¼ˆå·²å®Œæˆï¼‰
- [x] æ•°æ®åº“é©±åŠ¨çš„é…ç½®ç®¡ç†
- [x] RESTful APIï¼ˆç”¨æˆ·ç®¡ç†ï¼‰
- [x] è®¾å¤‡è®¿é—®æ—¥å¿—è®°å½•
- [x] é…ç½®çƒ­æ›´æ–°

### ğŸ”œ Phase 3ï¼ˆè§„åˆ’ä¸­ï¼‰
- [ ] è®¾å¤‡æ•°é‡é™åˆ¶
- [ ] æµé‡ç»Ÿè®¡ä¸ç›‘æ§
- [ ] Grafana + Prometheus ç›‘æ§é¢æ¿
- [ ] Web ç®¡ç†ç•Œé¢
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆCI/CDï¼‰

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| **ä»£ç†æ ¸å¿ƒ** | V2Ray (VLESS) | æµé‡ä»£ç† |
| **åå‘ä»£ç†** | Caddy 2 | TLS + è·¯ç”±åˆ†å‘ |
| **API æœåŠ¡** | FastAPI + Uvicorn | ç”¨æˆ·ç®¡ç† |
| **æ•°æ®åº“** | SQLite | é…ç½®å­˜å‚¨ |
| **å®¹å™¨åŒ–** | Docker + Compose | æœåŠ¡ç¼–æ’ |
| **è‡ªåŠ¨åŒ–** | Makefile + Shell | éƒ¨ç½²è„šæœ¬ |

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
Avalon-Tunnel/
â”œâ”€â”€ app/                    # Python åº”ç”¨
â”‚   â”œâ”€â”€ api/               # API è·¯ç”±å’Œæ¨¡å‹
â”‚   â”œâ”€â”€ database/          # æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ main.py            # é…ç½®ç”Ÿæˆå™¨
â”œâ”€â”€ docker/                # Docker é…ç½®
â”‚   â”œâ”€â”€ Dockerfile.api     # API æœåŠ¡é•œåƒ
â”‚   â””â”€â”€ Dockerfile.manager # é…ç½®ç®¡ç†é•œåƒ
â”œâ”€â”€ scripts/               # è‡ªåŠ¨åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ diagnose-pre.sh    # ç¯å¢ƒé¢„æ£€æŸ¥
â”‚   â”œâ”€â”€ diagnose-post.sh   # æœåŠ¡éªŒè¯
â”‚   â”œâ”€â”€ setup-firewall.sh  # é˜²ç«å¢™é…ç½®
â”‚   â””â”€â”€ restart-v2ray.sh   # V2Ray é‡å¯
â”œâ”€â”€ data/                  # æŒä¹…åŒ–æ•°æ®
â”‚   â”œâ”€â”€ avalon.db          # SQLite æ•°æ®åº“
â”‚   â””â”€â”€ caddy/             # TLS è¯ä¹¦
â”œâ”€â”€ public/                # ä¼ªè£…ç½‘ç«™
â”œâ”€â”€ Makefile               # è‡ªåŠ¨åŒ–å‘½ä»¤
â”œâ”€â”€ docker-compose.yml     # æœåŠ¡ç¼–æ’
â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
```

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

## ğŸ“„ è®¸å¯è¯

MIT License

---

## âš ï¸ å…è´£å£°æ˜

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚è¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ï¼Œåˆç†ä½¿ç”¨ç½‘ç»œèµ„æºã€‚
